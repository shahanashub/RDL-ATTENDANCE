<div class="exam-marks-container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h1 style="margin: 0; font-size: 32px; color: #32325d; font-weight: 800;">üìù Exam Marks</h1>
            <p style="margin: 5px 0 0 0; color: #636b7d;">Manage academic results and performance</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('education') }}"
                style="padding: 10px 20px; background: #f4f5f7; color: #525f7f; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 13px;">üéì
                Education Hub</a>
            <a href="{{ url_for('dashboard') }}"
                style="padding: 10px 20px; background: #f4f5f7; color: #525f7f; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 13px;">üè†
                Dashboard</a>
        </div>
    </div>

    {% if session.role in ['admin', 'teacher'] %}
    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
        <button onclick="showSection('upload')" id="btnUpload"
            style="padding: 14px 28px; background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; flex: 1; box-shadow: 0 4px 15px rgba(94, 114, 228, 0.2);">üì§
            Upload Marks</button>
        <button onclick="showSection('view')" id="btnView"
            style="padding: 14px 28px; background: white; color: #5e72e4; border: 2px solid #5e72e4; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; flex: 1;">üëÅÔ∏è
            View Marks History</button>
    </div>

    <!-- Upload Marks Section -->
    <div id="sectionUpload"
        style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); border-left: 5px solid #5e72e4;">
        <h2 style="margin-top: 0; margin-bottom: 25px; font-size: 20px; color: #32325d;">Upload New Exam Marks</h2>
        <form action="{{ url_for('upload_marks') }}" method="POST" id="uploadForm">
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Class</label>
                    <select id="uploadClassNum" name="class_num" onchange="loadStudentsForUpload()"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                        <option value="">-- Class --</option>
                        <option value="1">Class 1</option>
                        <option value="2">Class 2</option>
                        <option value="3">Class 3</option>
                        <option value="4">Class 4</option>
                        <option value="5">Class 5</option>
                        <option value="6">Class 6</option>
                        <option value="7">Class 7</option>
                        <option value="8">Class 8</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Section</label>
                    <select id="uploadSection" name="section" onchange="loadStudentsForUpload()"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                        <option value="">-- Section --</option>
                        <option value="A">Section A</option>
                        <option value="B">Section B</option>
                        <option value="C">Section C</option>
                        <option value="D">Section D</option>
                    </select>
                </div>
                <div class="form-group">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Subject</label>
                    <input type="text" id="uploadSubject" name="subject_name" list="subjectSuggestions"
                        placeholder="eg:- Mathematics"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                    <datalist id="subjectSuggestions"></datalist>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Exam
                        Name</label>
                    <input type="text" name="exam_name" placeholder="Unit Test 1"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Total
                        Marks</label>
                    <input type="number" id="totalMarkInput" name="total_mark" value="100"
                        oninput="updateAllLiveDetails()"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Pass
                        Marks</label>
                    <input type="number" id="passMarkInput" name="pass_mark" value="35" oninput="updateAllLiveDetails()"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                </div>
            </div>

            <input type="hidden" id="uploadClassId" name="class_id">

            <div style="margin-bottom: 25px; text-align: center;">
                <button type="button" id="btnLoadStudents" onclick="loadStudentsForUpload()"
                    style="padding: 10px 20px; background: #f4f5f7; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; font-weight: 700; color: #525f7f; transition: all 0.2s;">üîÑ
                    Load Student List</button>
            </div>

            <div id="studentMarksTable" style="display: none; margin-bottom: 30px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fe; border-bottom: 2px solid #e9ecef;">
                            <th style="padding: 15px; text-align: left; font-size: 13px; color: #8898aa;">Student Name
                            </th>
                            <th style="padding: 15px; text-align: left; font-size: 13px; color: #8898aa;">Reg No</th>
                            <th style="padding: 15px; text-align: center; font-size: 13px; color: #8898aa;">Mark Scored
                            </th>
                            <th style="padding: 15px; text-align: center; font-size: 13px; color: #8898aa;">Status</th>
                            <th style="padding: 15px; text-align: center; font-size: 13px; color: #8898aa;">Percentage
                            </th>
                        </tr>
                    </thead>
                    <tbody id="uploadTbody"></tbody>
                </table>
            </div>

            <div style="text-align: right;">
                <button type="submit"
                    style="padding: 16px 50px; background: linear-gradient(135deg, #2dce89 0%, #2dcecc 100%); color: white; border: none; border-radius: 8px; font-weight: 700; text-transform: uppercase; cursor: pointer;">üíæ
                    Save Marks</button>
            </div>
        </form>
    </div>

    <!-- View Marks Section -->
    <div id="sectionView"
        style="display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); border-left: 5px solid #11cdef;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="margin: 0; font-size: 20px; color: #32325d;">View Performance History</h2>
            {% if session.role == 'admin' %}
            <button type="button" onclick="toggleManageExams()"
                style="background: #11cdef; color: white; border: none; border-radius: 4px; padding: 5px 12px; cursor: pointer; font-size: 13px; font-weight: bold;">Manage
                Exams</button>
            {% endif %}
        </div>

        <div id="manageExamsPanel"
            style="display: none; margin-bottom: 25px; background: #f8f9fe; padding: 20px; border-radius: 8px; border: 1px solid #e3e3e3;">
            <h3 style="margin-top: 0; font-size: 16px; color: #32325d;">Existing Exams</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                {% for exam in exams %}
                <div
                    style="background: white; border: 1px solid #11cdef; color: #11cdef; padding: 6px 15px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    {{ exam.exam_name }}
                    <form action="{{ url_for('delete_exam', exam_id=exam.id) }}" method="POST" style="margin: 0;"
                        onsubmit="return confirm('Deleting this exam will delete all marks for all students in this exam. Are you sure?')">
                        <button type="submit"
                            style="background: none; border: none; color: #f5365c; cursor: pointer; padding: 0; font-weight: bold; font-size: 16px;">‚úï</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; align-items: end;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Class</label>
                <select id="viewClassNum"
                    style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;">
                    <option value="">-- Class --</option>
                    <option value="1">Class 1</option>
                    <option value="2">Class 2</option>
                    <option value="3">Class 3</option>
                    <option value="4">Class 4</option>
                    <option value="5">Class 5</option>
                    <option value="6">Class 6</option>
                    <option value="7">Class 7</option>
                    <option value="8">Class 8</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>

                </select>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Section</label>
                <select id="viewSection"
                    style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;">
                    <option value="">-- Sec --</option>
                    <option value="A">Section A</option>
                    <option value="B">Section B</option>
                    <option value="C">Section C</option>
                    <option value="D">Section D</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Exam</label>
                <select id="viewExam"
                    style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;">
                    <option value="">-- Select Exam --</option>
                    {% for exam in exams %}<option value="{{ exam.id }}">{{ exam.exam_name }}</option>{% endfor %}
                </select>
            </div>
            <button id="btnSearchHistory" onclick="fetchResults()"
                style="padding: 14px 24px; background: #5e72e4; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s;">üîç
                Search</button>
        </div>

        <div id="resultsTable" style="display: none;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fe; border-bottom: 2px solid #e9ecef;">
                        <th style="padding: 15px; text-align: left; font-size: 12px; color: #8898aa;">Student Info</th>
                        <th style="padding: 15px; text-align: left; font-size: 12px; color: #8898aa;">Subject</th>
                        <th style="padding: 15px; text-align: center; font-size: 12px; color: #8898aa;">Score</th>
                        <th style="padding: 15px; text-align: center; font-size: 12px; color: #8898aa;">Status</th>
                        <th style="padding: 15px; text-align: center; font-size: 12px; color: #8898aa;">Percentage</th>
                    </tr>
                </thead>
                <tbody id="resultsTbody"></tbody>
            </table>
        </div>
    </div>

    {% else %}
    <!-- Student View -->
    <div
        style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); border-top: 5px solid #fb6340;">
        <h2 style="margin-top: 0; margin-bottom: 30px; text-align: center; color: #32325d;">My Performance Report</h2>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; max-width: 900px; margin: 0 auto 40px auto; align-items: end;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Reg No</label>
                <input type="text" id="studentRegNo" placeholder="Enter Registration No"
                    style="width: 100%; padding: 12px; border: 2px solid #fb6340; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">Exam</label>
                <select id="studentExam"
                    style="width: 100%; padding: 12px; border: 2px solid #fb6340; border-radius: 8px;">
                    <option value="">-- Choose Exam --</option>
                    {% for exam in exams %}<option value="{{ exam.id }}">{{ exam.exam_name }}</option>{% endfor %}
                </select>
            </div>
            <button id="btnViewReport" onclick="fetchStudentResults()"
                style="padding: 14px 24px; background: #fb6340; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s;">üìä
                View Report</button>
        </div>

        <div id="studentResultsArea" style="display: none;">
            <div
                style="background: #f8f9fe; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px dashed #ced4da;">
                <h3 id="studentHeader" style="margin: 0; color: #32325d; font-size: 20px;"></h3>
            </div>
            <table style="width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: #32325d; color: white;">
                        <th style="padding: 18px; text-align: left;">Subject</th>
                        <th style="padding: 18px; text-align: center;">Score</th>
                        <th style="padding: 18px; text-align: center;">Total</th>
                        <th style="padding: 18px; text-align: center;">Status</th>
                        <th style="padding: 18px; text-align: center;">%</th>
                    </tr>
                </thead>
                <tbody id="studentResultsTbody"></tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    const role = '{{ session.role }}';
    function toggleManageExams() {
        const panel = document.getElementById('manageExamsPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    const classesMap = {
        {% for cls in classes %}
    "{{ cls.class_name.upper().replace('CLASS', '').strip() }}-{{ cls.section.upper().strip() }}": {{ cls.id }},
    {% endfor %}
    };

    function showSection(section) {
        const uploadSect = document.getElementById('sectionUpload');
        const viewSect = document.getElementById('sectionView');
        if (uploadSect) uploadSect.style.display = section === 'upload' ? 'block' : 'none';
        if (viewSect) viewSect.style.display = section === 'view' ? 'block' : 'none';

        const btnUpload = document.getElementById('btnUpload');
        const btnView = document.getElementById('btnView');

        if (btnUpload && btnView) {
            if (section === 'upload') {
                btnUpload.style.background = '#5e72e4'; btnUpload.style.color = 'white';
                btnView.style.background = 'white'; btnView.style.color = '#5e72e4'; btnView.style.border = '2px solid #5e72e4';
            } else {
                btnView.style.background = '#5e72e4'; btnView.style.color = 'white';
                btnUpload.style.background = 'white'; btnUpload.style.color = '#5e72e4'; btnUpload.style.border = '2px solid #5e72e4';
            }
        }
    }

    async function loadStudentsForUpload() {
        const btn = document.getElementById('btnLoadStudents');
        const originalText = btn.innerHTML;
        try {
            const classNum = document.getElementById('uploadClassNum').value;
            const section = document.getElementById('uploadSection').value;
            console.log('loadStudentsForUpload called with:', classNum, section);

            if (!classNum || !section) {
                alert('Please select BOTH Class and Section first.');
                return;
            }

            btn.innerHTML = '‚è≥ Loading...';
            btn.disabled = true;
            btn.style.opacity = '0.7';

            const key = classNum.trim().toUpperCase() + '-' + section.trim().toUpperCase();
            console.log('Lookup Key:', key);
            console.log('Available ClassesMap Keys:', Object.keys(classesMap));

            const classId = classesMap[key];
            console.log('Found ClassID:', classId);

            if (!classId) {
                alert(`Error: Class "${key}" not found in system map.\nGenerated Key: "${key}"\nAvailable: ${Object.keys(classesMap).join(', ')}\n\nPlease ensure Class and Section are correctly selected.`);
                return;
            }

            document.getElementById('uploadClassId').value = classId;

            // Load subjects
            fetch(`/get_subjects/${classNum}-${section}`)
                .then(r => r.json())
                .then(subjects => {
                    const dl = document.getElementById('subjectSuggestions');
                    dl.innerHTML = '';
                    subjects.forEach(s => dl.innerHTML += `<option value="${s.subject_name}">`);
                    console.log('Subjects loaded:', subjects.length);
                })
                .catch(err => console.error('Subject fetch error:', err));

            // Load students
            console.log('Fetching students for ID:', classId);
            const studResp = await fetch(`/get_class_students/${classId}`);

            if (!studResp.ok) {
                throw new Error(`Server returned status ${studResp.status}: ${studResp.statusText}`);
            }

            const data = await studResp.json();
            console.log('Student data received:', data);

            if (data.success && data.students && data.students.length > 0) {
                document.getElementById('studentMarksTable').style.display = 'block';
                const tbody = document.getElementById('uploadTbody');
                tbody.innerHTML = '';
                data.students.forEach(s => {
                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #f2f4f6;">
                            <td style="padding: 12px; font-weight: 600;">${s.name}</td>
                            <td style="padding: 12px; color: #8898aa;">${s.reg_no}</td>
                            <td style="padding: 12px; text-align: center;">
                                <input type="hidden" name="reg_nos[]" value="${s.reg_no}">
                                <input type="number" step="0.5" name="marks[]" oninput="updateLiveRow(this)" placeholder="Score" 
                                    style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; width: 80px; text-align: center;">
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span class="live-status" style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; background: #eee;">-</span>
                            </td>
                            <td style="padding: 12px; text-align: center; font-weight: 700;" class="live-percent">-</td>
                        </tr>
                    `;
                });
                console.log('Table populated with', data.students.length, 'students');
            } else {
                document.getElementById('studentMarksTable').style.display = 'none';
                alert('No students found for this class/section in the database.');
            }
        } catch (error) {
            console.error('Critical failure in loadStudentsForUpload:', error);
            alert('Critical Error: ' + error.message + '\n\nPlease check the console for more details.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }

    function updateLiveRow(input) {
        const row = input.closest('tr');
        const score = parseFloat(input.value) || 0;
        const total = parseFloat(document.getElementById('totalMarkInput').value) || 100;
        const pass = parseFloat(document.getElementById('passMarkInput').value) || 35;

        const percent = ((score / total) * 100).toFixed(1);
        const isPass = score >= pass;

        row.querySelector('.live-percent').innerText = percent + '%';
        const badge = row.querySelector('.live-status');
        badge.innerText = isPass ? 'PASS' : 'FAIL';
        badge.style.background = isPass ? '#e8f9ee' : '#fff1f4';
        badge.style.color = isPass ? '#2dce89' : '#f5365c';
    }

    function updateAllLiveDetails() {
        document.querySelectorAll('input[name="marks[]"]').forEach(input => updateLiveRow(input));
    }

    async function fetchResults() {
        const btn = document.getElementById('btnSearchHistory');
        const originalText = btn.innerHTML;
        try {
            const num = document.getElementById('viewClassNum').value;
            const sec = document.getElementById('viewSection').value;
            const exam = document.getElementById('viewExam').value;
            if (!num || !sec || !exam) return alert('Select all filters');

            btn.innerHTML = '‚è≥ Searching...';
            btn.disabled = true;

            const key = num.trim().toUpperCase() + '-' + sec.trim().toUpperCase();
            const classId = classesMap[key];

            if (!classId) {
                alert(`Error: Class "${key}" not found.`);
                return;
            }

            const resp = await fetch(`/get_exam_results?class_id=${classId}&exam_id=${exam}`);
            const data = await resp.json();

            const table = document.getElementById('resultsTable');
            const theadTr = table.querySelector('thead tr');
            const tbody = document.getElementById('resultsTbody');
            tbody.innerHTML = '';

            if (data.success && data.results && data.results.length > 0) {
                table.style.display = 'block';

                // 1. Group results by student and identify all subjects
                const students = {};
                const subjectsSet = new Set();
                data.results.forEach(r => {
                    if (!students[r.reg_no]) {
                        students[r.reg_no] = {
                            name: r.student_name,
                            reg_no: r.reg_no,
                            marks: {},
                            totalScored: 0,
                            totalPotential: 0
                        };
                    }
                    students[r.reg_no].marks[r.subject_name] = r;
                    students[r.reg_no].totalScored += r.marks_scored;
                    students[r.reg_no].totalPotential += r.total_marks;
                    subjectsSet.add(r.subject_name);
                });

                const sortedSubjects = Array.from(subjectsSet).sort();

                // 2. Build Dynamic Header
                let headerContent = `<th style="padding: 15px; text-align: left; font-size: 11px; color: #8898aa; text-transform: uppercase;">Student Info</th>`;
                sortedSubjects.forEach(sub => {
                    headerContent += `<th style="padding: 15px; text-align: center; font-size: 11px; color: #8898aa; text-transform: uppercase;">${sub}</th>`;
                    headerContent += `<th style="padding: 15px; text-align: center; font-size: 11px; color: #8898aa; text-transform: uppercase;">Status</th>`;
                });
                headerContent += `<th style="padding: 15px; text-align: center; font-size: 11px; color: #8898aa; text-transform: uppercase;">Total Marks</th>`;
                headerContent += `<th style="padding: 15px; text-align: center; font-size: 11px; color: #8898aa; text-transform: uppercase;">Overall %</th>`;
                headerContent += `<th style="padding: 15px; text-align: center; font-size: 11px; color: #8898aa; text-transform: uppercase;">Action</th>`;
                theadTr.innerHTML = headerContent;

                // 3. Build Body Rows
                Object.values(students).forEach(s => {
                    let row = `<td style="padding: 15px; min-width: 150px;"><b>${s.name}</b><br><small style="color: #8898aa;">${s.reg_no}</small></td>`;

                    sortedSubjects.forEach(sub => {
                        const m = s.marks[sub];
                        if (m) {
                            const isPass = m.marks_scored >= m.pass_mark;
                            row += `<td style="padding: 15px; text-align: center;"><b>${m.marks_scored}</b> / ${m.total_marks}</td>`;
                            row += `<td style="padding: 15px; text-align: center;">
                                <span style="padding: 4px 10px; border-radius: 20px; background: ${isPass ? '#e8f9ee' : '#fff1f4'}; color: ${isPass ? '#2dce89' : '#f5365c'}; font-size: 10px; font-weight: 700;">${isPass ? 'PASS' : 'FAIL'}</span>
                            </td>`;
                        } else {
                            row += `<td style="padding: 15px; text-align: center; color: #adb5bd;">-</td><td style="padding: 15px; text-align: center; color: #adb5bd;">-</td>`;
                        }
                    });

                    const overallPercent = ((s.totalScored / s.totalPotential) * 100).toFixed(1);
                    row += `<td style="padding: 15px; text-align: center;"><b>${s.totalScored}</b> / ${s.totalPotential}</td>`;
                    row += `<td style="padding: 15px; text-align: center;"><span style="font-weight: 800; color: #5e72e4;">${overallPercent}%</span></td>`;

                    // Action cell with subject-specific buttons
                    let actionHtml = `<td style="padding: 15px; text-align: center; min-width: 120px;">`;
                    Object.values(s.marks).forEach(m => {
                        actionHtml += `
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px;">
                                <small style="max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${m.subject_name}">${m.subject_name}</small>
                                <button onclick="editMark(${m.id}, ${m.marks_scored})" style="background: none; border: none; color: #5e72e4; cursor: pointer; font-size: 14px;" title="Edit ${m.subject_name}">‚úèÔ∏è</button>
                                <button onclick="deleteMark(${classId}, '${m.subject_name}', ${exam}, '${s.reg_no}')" style="background: none; border: none; color: #f5365c; cursor: pointer; font-size: 14px;" title="Delete ${m.subject_name}">üóëÔ∏è</button>
                            </div>
                        `;
                    });
                    actionHtml += `</td>`;
                    row += actionHtml;

                    tbody.innerHTML += `<tr style="border-bottom: 1px solid #f2f4f6;">${row}</tr>`;
                });
            } else {
                table.style.display = 'none';
                alert('No results found for the selected criteria.');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Failed to fetch results');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function editMark(markId, currentScore) {
        const newScore = prompt("Enter new marks scored:", currentScore);
        if (newScore === null || newScore === "" || isNaN(newScore)) return;

        try {
            const resp = await fetch('/update_mark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: markId, marks_scored: parseFloat(newScore) })
            });
            const data = await resp.json();
            if (data.success) {
                alert('Mark updated successfully');
                fetchResults();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (e) {
            console.error(e);
            alert('Failed to update mark');
        }
    }

    async function deleteMark(classId, subjectName, examId, regNo) {
        if (!confirm('Are you sure you want to delete this mark?')) return;

        try {
            const resp = await fetch('/delete_mark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ class_id: classId, subject_name: subjectName, exam_id: examId, reg_no: regNo })
            });
            const data = await resp.json();
            if (data.success) {
                alert('Mark deleted successfully');
                fetchResults(); // Refresh table
            } else {
                alert('Error: ' + data.message);
            }
        } catch (e) {
            console.error(e);
            alert('Failed to delete mark');
        }
    }

    async function fetchStudentResults() {
        const btn = document.getElementById('btnViewReport');
        const originalText = btn.innerHTML;
        try {
            const reg = document.getElementById('studentRegNo').value.trim();
            const exam = document.getElementById('studentExam').value;
            if (!reg || !exam) return alert('Please enter Registration Number and select an Exam');

            btn.innerHTML = '‚è≥ Loading...';
            btn.disabled = true;

            const resp = await fetch(`/get_exam_results?exam_id=${exam}&reg_no=${encodeURIComponent(reg)}`);
            const data = await resp.json();

            const resultsArea = document.getElementById('studentResultsArea');
            const tbody = document.getElementById('studentResultsTbody');

            if (data.success && data.results && data.results.length > 0) {
                resultsArea.style.display = 'block';
                document.getElementById('studentHeader').innerText = `Performance Report: ${data.results[0].student_name}`;
                tbody.innerHTML = '';
                data.results.forEach(r => {
                    const isPass = r.marks_scored >= r.pass_mark;
                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 15px; font-weight: 700;">${r.subject_name}</td>
                            <td style="padding: 15px; text-align: center; color: #5e72e4; font-weight: 800;">${r.marks_scored}</td>
                            <td style="padding: 15px; text-align: center; color: #8898aa;">${r.total_marks}</td>
                            <td style="padding: 15px; text-align: center;"><span style="padding: 4px 10px; border-radius: 20px; background: ${isPass ? '#e8f9ee' : '#fff1f4'}; color: ${isPass ? '#2dce89' : '#f5365c'}; font-size: 11px; font-weight: 700;">${isPass ? 'PASS' : 'FAIL'}</span></td>
                            <td style="padding: 15px; text-align: center; font-weight: 700;">${((r.marks_scored / r.total_marks) * 100).toFixed(1)}%</td>
                        </tr>`;
                });
            } else {
                resultsArea.style.display = 'none';
                alert(data.message || 'No records found for this Registration Number and Exam.');
            }
        } catch (error) {
            console.error('Student fetch error:', error);
            alert('Failed to fetch report: ' + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>
