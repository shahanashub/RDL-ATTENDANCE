<div class="exam-marks-container" style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h1 style="margin: 0; font-size: 32px; color: #32325d; font-weight: 800;">üìù Exam Marks</h1>
            <p style="margin: 5px 0 0 0; color: #636b7d;">Manage academic results and performance</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('education') }}"
                style="padding: 10px 20px; background: #f4f5f7; color: #525f7f; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 13px;">üéì
                Education Hub</a>
            <a href="{{ url_for('dashboard') }}"
                style="padding: 10px 20px; background: #f4f5f7; color: #525f7f; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 13px;">üè†
                Dashboard</a>
        </div>
    </div>

    {% if session.role in ['admin', 'teacher'] %}
    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
        <button onclick="showSection('upload')" id="btnUpload"
            style="padding: 14px 28px; background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; flex: 1; box-shadow: 0 4px 15px rgba(94, 114, 228, 0.2);">üì§
            Upload Marks</button>
        <button onclick="showSection('view')" id="btnView"
            style="padding: 14px 28px; background: white; color: #5e72e4; border: 2px solid #5e72e4; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; flex: 1;">üëÅÔ∏è
            View Marks</button>
    </div>

    <!-- Upload Marks Section -->
    <div id="sectionUpload"
        style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); border-left: 5px solid #5e72e4;">
        <h2 style="margin-top: 0; margin-bottom: 25px; font-size: 20px; color: #32325d;">Upload New Exam Marks</h2>
        <form action="{{ url_for('upload_marks') }}" method="POST" id="uploadForm">
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <div class="form-group">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Class</label>
                    <select id="uploadClass" name="class_id" onchange="loadStudentsForUpload()"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                        <option value="">-- Select Class --</option>
                        {% for cls in classes %}
                        <option value="{{ cls.id }}" data-num="{{ cls.class_name.replace('Class ', '') }}"
                            data-sec="{{ cls.section }}">{{ cls.class_name }} - {{ cls.section }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Subject</label>
                    <select id="uploadSubject" name="subject_id"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                        <option value="">-- Select Subject --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Exam
                        Name</label>
                    <input type="text" name="exam_name" placeholder="e.g. Midterm 1"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                </div>
                <div class="form-group">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Total
                        Marks</label>
                    <input type="number" name="total_mark" placeholder="100"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                </div>
                <div class="form-group">
                    <label
                        style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Pass
                        Marks</label>
                    <input type="number" name="pass_mark" placeholder="35"
                        style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;" required>
                </div>
            </div>

            <div id="studentMarksTable" style="display: none; margin-bottom: 25px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fe; border-bottom: 2px solid #e9ecef;">
                            <th style="padding: 15px; text-align: left; font-size: 13px; color: #8898aa;">Student Name
                            </th>
                            <th style="padding: 15px; text-align: left; font-size: 13px; color: #8898aa;">Reg No</th>
                            <th style="padding: 15px; text-align: left; font-size: 13px; color: #8898aa;">Marks Scored
                            </th>
                        </tr>
                    </thead>
                    <tbody id="uploadTbody"></tbody>
                </table>
            </div>

            <div style="text-align: right;">
                <button type="submit"
                    style="padding: 14px 40px; background: linear-gradient(135deg, #2dce89 0%, #2dcecc 100%); color: white; border: none; border-radius: 8px; font-weight: 700; text-transform: uppercase; cursor: pointer; box-shadow: 0 4px 15px rgba(45, 206, 137, 0.2);">üíæ
                    Save Marks</button>
            </div>
        </form>
    </div>

    <!-- View Marks Section -->
    <div id="sectionView"
        style="display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); border-left: 5px solid #11cdef;">
        <h2 style="margin-top: 0; margin-bottom: 25px; font-size: 20px; color: #32325d;">View Performance History</h2>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; align-items: end;">
            <div class="form-group">
                <label
                    style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Class</label>
                <select id="viewClass"
                    style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;">
                    <option value="">-- Select Class --</option>
                    {% for cls in classes %}
                    <option value="{{ cls.id }}">{{ cls.class_name }} - {{ cls.section }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label
                    style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Exam</label>
                <select id="viewExam"
                    style="width: 100%; padding: 12px; border: 2px solid #e3e3e3; border-radius: 8px;">
                    <option value="">-- Select Exam --</option>
                    {% for exam in exams %}
                    <option value="{{ exam.id }}">{{ exam.exam_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button onclick="fetchResults()"
                style="padding: 14px 24px; background: #5e72e4; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">üîç
                Search</button>
        </div>

        <div id="resultsTable" style="display: none;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fe; border-bottom: 2px solid #e9ecef;">
                        <th style="padding: 15px; text-align: left; font-size: 12px; color: #8898aa;">Student Info</th>
                        <th style="padding: 15px; text-align: left; font-size: 12px; color: #8898aa;">Subject</th>
                        <th style="padding: 15px; text-align: center; font-size: 12px; color: #8898aa;">Score</th>
                        <th style="padding: 15px; text-align: center; font-size: 12px; color: #8898aa;">Status</th>
                        <th style="padding: 15px; text-align: center; font-size: 12px; color: #8898aa;">Percentage</th>
                    </tr>
                </thead>
                <tbody id="resultsTbody"></tbody>
            </table>
        </div>
    </div>

    {% else %}
    <!-- Student View -->
    <div
        style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); border-top: 5px solid #fb6340;">
        <h2 style="margin-top: 0; margin-bottom: 30px; text-align: center; color: #32325d;">My Performance</h2>
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 800px; margin: 0 auto 40px auto; align-items: end;">
            <div class="form-group">
                <label
                    style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px; color: #32325d;">Select
                    Exam</label>
                <select id="studentExam"
                    style="width: 100%; padding: 12px; border: 2px solid #fb6340; border-radius: 8px;">
                    <option value="">-- Choose Exam --</option>
                    {% for exam in exams %}
                    <option value="{{ exam.id }}">{{ exam.exam_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button onclick="fetchStudentResults()"
                style="padding: 14px 24px; background: #fb6340; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase;">üìä
                View Report</button>
        </div>

        <div id="studentResultsArea" style="display: none;">
            <div
                style="background: #f8f9fe; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px dashed #ced4da;">
                <h3 id="studentHeader" style="margin: 0; color: #32325d; font-size: 20px;"></h3>
            </div>
            <table
                style="width: 100%; border-collapse: collapse; box-shadow: 0 4px 15px rgba(0,0,0,0.02); border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background: #32325d; color: white;">
                        <th style="padding: 18px; text-align: left;">Subject</th>
                        <th style="padding: 18px; text-align: center;">Score</th>
                        <th style="padding: 18px; text-align: center;">Total</th>
                        <th style="padding: 18px; text-align: center;">Status</th>
                        <th style="padding: 18px; text-align: center;">%</th>
                    </tr>
                </thead>
                <tbody id="studentResultsTbody"></tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function showSection(section) {
        document.getElementById('sectionUpload').style.display = section === 'upload' ? 'block' : 'none';
        document.getElementById('sectionView').style.display = section === 'view' ? 'block' : 'none';

        const btnUpload = document.getElementById('btnUpload');
        const btnView = document.getElementById('btnView');

        if (section === 'upload') {
            btnUpload.style.background = 'linear-gradient(135deg, #5e72e4 0%, #825ee4 100%)';
            btnUpload.style.color = 'white';
            btnView.style.background = 'white';
            btnView.style.color = '#5e72e4';
        } else {
            btnView.style.background = 'linear-gradient(135deg, #11cdef 0%, #11cda3 100%)';
            btnView.style.color = 'white';
            btnUpload.style.background = 'white';
            btnUpload.style.color = '#5e72e4';
        }
    }

    async function loadStudentsForUpload() {
        const classSelect = document.getElementById('uploadClass');
        const classId = classSelect.value;
        const selectedOption = classSelect.options[classSelect.selectedIndex];
        const classNum = selectedOption.getAttribute('data-num');
        const section = selectedOption.getAttribute('data-sec');

        if (!classId) return;

        // Load subjects
        const subjResp = await fetch(`/get_subjects/${classNum}-${section}`);
        const subjects = await subjResp.json();
        const subjSelect = document.getElementById('uploadSubject');
        subjSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        subjects.forEach(s => {
            subjSelect.innerHTML += `<option value="${s.id}">${s.subject_name}</option>`;
        });

        // Load students (we'll fetch from attendance history since it already lists students)
        const histResp = await fetch(`/get_attendance_history/${classId}`);
        const histData = await histResp.json();

        if (histData.success && histData.records.length > 0) {
            // Just take students from the first (latest) history entry
            const students = histData.records[0].students;
            document.getElementById('studentMarksTable').style.display = 'block';
            const tbody = document.getElementById('uploadTbody');
            tbody.innerHTML = '';
            students.forEach(s => {
                tbody.innerHTML += `
                    <tr style="border-bottom: 1px solid #f2f4f6;">
                        <td style="padding: 12px;">${s.name}</td>
                        <td style="padding: 12px;">${s.reg_no}</td>
                        <td style="padding: 12px;">
                            <input type="hidden" name="reg_nos[]" value="${s.reg_no}">
                            <input type="number" step="0.5" name="marks[]" placeholder="Enter Score" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 120px;">
                        </td>
                    </tr>
                `;
            });
        }
    }

    async function fetchResults() {
        const classId = document.getElementById('viewClass').value;
        const examId = document.getElementById('viewExam').value;
        if (!classId || !examId) return alert('Select class and exam');

        const resp = await fetch(`/get_exam_results?class_id=${classId}&exam_id=${examId}`);
        const data = await resp.json();

        if (data.success) {
            const table = document.getElementById('resultsTable');
            const tbody = document.getElementById('resultsTbody');
            table.style.display = 'block';
            tbody.innerHTML = '';

            data.results.forEach(r => {
                const percent = ((r.marks_scored / r.total_marks) * 100).toFixed(1);
                const isPass = r.marks_scored >= r.pass_mark;
                tbody.innerHTML += `
                    <tr style="border-bottom: 1px solid #f2f4f6;">
                        <td style="padding: 15px;">
                            <div style="font-weight: 700; color: #32325d;">${r.student_name}</div>
                            <div style="font-size: 11px; color: #8898aa;">${r.reg_no}</div>
                        </td>
                        <td style="padding: 15px; color: #525f7f;">${r.subject_name}</td>
                        <td style="padding: 15px; text-align: center; font-weight: 700;">${r.marks_scored} <small>/ ${r.total_marks}</small></td>
                        <td style="padding: 15px; text-align: center;">
                            <span style="padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; background: ${isPass ? '#e8f9ee' : '#fff1f4'}; color: ${isPass ? '#2dce89' : '#f5365c'};">
                                ${isPass ? 'PASS' : 'FAIL'}
                            </span>
                        </td>
                        <td style="padding: 15px; text-align: center; color: #525f7f;">${percent}%</td>
                    </tr>
                `;
            });
        }
    }

    async function fetchStudentResults() {
        const examId = document.getElementById('studentExam').value;
        if (!examId) return alert('Select an exam');

        const resp = await fetch(`/get_exam_results?exam_id=${examId}`);
        const data = await resp.json();

        if (data.success && data.results.length > 0) {
            const area = document.getElementById('studentResultsArea');
            const tbody = document.getElementById('studentResultsTbody');
            const header = document.getElementById('studentHeader');

            header.innerHTML = `Report for: <span style="color: #fb6340;">${data.results[0].student_name}</span> | ID: ${data.results[0].reg_no}`;
            area.style.display = 'block';
            tbody.innerHTML = '';

            let totalScored = 0;
            let maxPossible = 0;

            data.results.forEach(r => {
                const percent = ((r.marks_scored / r.total_marks) * 100).toFixed(1);
                const isPass = r.marks_scored >= r.pass_mark;
                totalScored += r.marks_scored;
                maxPossible += r.total_marks;

                tbody.innerHTML += `
                    <tr style="border-bottom: 1px solid #f2f4f6;">
                        <td style="padding: 18px; font-weight: 700; color: #32325d;">${r.subject_name}</td>
                        <td style="padding: 18px; text-align: center; font-weight: 800; color: #5e72e4;">${r.marks_scored}</td>
                        <td style="padding: 18px; text-align: center; color: #8898aa;">${r.total_marks}</td>
                        <td style="padding: 18px; text-align: center;">
                            <span style="padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; background: ${isPass ? '#e8f9ee' : '#fff1f4'}; color: ${isPass ? '#2dce89' : '#f5365c'};">
                                ${isPass ? 'PASS' : 'FAIL'}
                            </span>
                        </td>
                        <td style="padding: 18px; text-align: center; font-weight: 700; color: #32325d;">${percent}%</td>
                    </tr>
                `;
            });

            // Add Total Row
            const totalPercent = ((totalScored / maxPossible) * 100).toFixed(1);
            tbody.innerHTML += `
                <tr style="background: #f8f9fe; border-top: 2px solid #32325d;">
                    <td style="padding: 18px; font-weight: 800; text-transform: uppercase; color: #32325d;">Total Aggregate</td>
                    <td style="padding: 18px; text-align: center; font-weight: 900; color: #5e72e4; font-size: 20px;">${totalScored}</td>
                    <td style="padding: 18px; text-align: center; font-weight: 700;">${maxPossible}</td>
                    <td style="padding: 18px; text-align: center;">-</td>
                    <td style="padding: 18px; text-align: center; font-weight: 900; color: #32325d; font-size: 20px;">${totalPercent}%</td>
                </tr>
            `;
        } else {
            alert('No records found for this exam');
        }
    }
</script>