<div style="margin-bottom: 30px;">
    <button type="button" onclick="toggleStudentSheet()" style="
        padding: 14px 32px;
        background: linear-gradient(135deg, #fb6340 0%, #ff6b9d 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(251, 99, 64, 0.3);
        font-size: 14px;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(251, 99, 64, 0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(251, 99, 64, 0.3)'">
        üîê Upload Student Sheet
    </button>

    <div id="studentSheetPanel"
        style="display: none; margin-top: 25px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(251, 99, 64, 0.15); border-left: 5px solid #fb6340;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: #32325d;">Add Student Details & Subjects
            </h2>
            {% if session.role == 'admin' %}
            <button type="button" onclick="toggleManageClasses()"
                style="background: #fb6340; color: white; border: none; border-radius: 4px; padding: 5px 12px; cursor: pointer; font-size: 13px; font-weight: bold;">Manage
                Classes</button>
            {% endif %}
        </div>

        <div id="manageClassesPanel"
            style="display: none; margin-bottom: 25px; background: #fff5f2; padding: 20px; border-radius: 8px; border: 1px solid #ffdec9;">
            <h3 style="margin-top: 0; font-size: 16px; color: #32325d;">Existing Classes</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                {% for cls in classes %}
                <div
                    style="background: white; border: 1px solid #fb6340; color: #fb6340; padding: 6px 15px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    {{ cls.class_name }} - {{ cls.section }}
                    <form action="{{ url_for('delete_class', class_id=cls.id) }}" method="POST" style="margin: 0;"
                        onsubmit="return confirm('Deleting this class will delete ALL students, subjects, attendance, marks, and fees associated with it. Are you sure?')">
                        <button type="submit"
                            style="background: none; border: none; color: #f5365c; cursor: pointer; padding: 0; font-weight: bold; font-size: 16px;">‚úï</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        <button type="button" onclick="toggleStudentSheet()" style="
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: #999;
            ">‚úï</button>
    </div>

    <!-- Subject Upload Section -->
    <div
        style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #5e72e4;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #32325d; font-size: 16px;">üìö Add Subjects for Class</h3>
            <button type="button" onclick="toggleManageSubjects()"
                style="background: #5e72e4; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; font-weight: bold;">Manage
                Existing Subjects</button>
        </div>

        <div id="manageSubjectsPanel"
            style="display: none; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e3e3e3;">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="manageClassNum" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="">-- Class --</option>
                    {% for i in range(1, 13) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
                </select>
                <select id="manageSection" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="">-- Sec --</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
                <button type="button" onclick="loadSubjectsForManagement()"
                    style="padding: 8px 15px; background: #5e72e4; color: white; border: none; border-radius: 4px; cursor: pointer;">Show</button>
            </div>
            <div id="subjectsList" style="display: flex; flex-wrap: wrap; gap: 10px;">
                <!-- Subjects will appear here -->
            </div>
        </div>

        <form method="POST" action="{{ url_for('add_subjects') }}" style="display: grid; gap: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: start;">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label
                        style="font-weight: 700; color: #32325d; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">üìö
                        Class</label>
                    <select id="subjectClassNum" name="class_num" style="
                            padding: 12px 16px;
                            border: 2px solid #e3e3e3;
                            border-radius: 8px;
                            font-size: 14px;
                            font-family: inherit;
                            background: white;
                            color: #32325d;
                            cursor: pointer;
                        " required>
                        <option value="">-- Select Class --</option>
                        <option value="1">Class 1</option>
                        <option value="2">Class 2</option>
                        <option value="3">Class 3</option>
                        <option value="4">Class 4</option>
                        <option value="5">Class 5</option>
                        <option value="6">Class 6</option>
                        <option value="7">Class 7</option>
                        <option value="8">Class 8</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label
                        style="font-weight: 700; color: #32325d; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">üìã
                        Section</label>
                    <select id="subjectSection" name="section" style="
                            padding: 12px 16px;
                            border: 2px solid #e3e3e3;
                            border-radius: 8px;
                            font-size: 14px;
                            font-family: inherit;
                            background: white;
                            color: #32325d;
                            cursor: pointer;
                        " required>
                        <option value="">-- Select Section --</option>
                        <option value="A">Section A</option>
                        <option value="B">Section B</option>
                        <option value="C">Section C</option>
                        <option value="D">Section D</option>
                    </select>
                </div>

                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label
                        style="font-weight: 700; color: #32325d; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">üìñ
                        Subjects (comma-separated)</label>
                    <input type="text" name="subjects" placeholder="e.g., Math, English, Science" style="
                            padding: 12px 16px;
                            border: 2px solid #e3e3e3;
                            border-radius: 8px;
                            font-size: 14px;
                            font-family: inherit;
                        " required>
                    <button type="submit" style="
                            margin-top: 6px;
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 700;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(251, 99, 64, 0.3);
                            font-size: 12px;
                            align-self: flex-end;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(251, 99, 64, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(251, 99, 64, 0.3)'">
                        ‚ûï Add Subjects
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Student Upload Section -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="margin: 0; font-size: 16px; font-weight: 700; color: #32325d;">üë• Add Student Details</h3>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 25px; align-items: end;">
        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label
                style="font-weight: 700; color: #32325d; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">üìö
                Class</label>
            <select id="newClass" style="
                    padding: 12px 16px;
                    border: 2px solid #e3e3e3;
                    border-radius: 8px;
                    font-size: 14px;
                    font-family: inherit;
                    background: white;
                    color: #32325d;
                    cursor: pointer;
                " required>
                <option value="">-- Select Class --</option>
                <option value="1">Class 1</option>
                <option value="2">Class 2</option>
                <option value="3">Class 3</option>
                <option value="4">Class 4</option>
                <option value="5">Class 5</option>
                <option value="6">Class 6</option>
                <option value="7">Class 7</option>
                <option value="8">Class 8</option>
                <option value="9">Class 9</option>
                <option value="10">Class 10</option>
            </select>
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label
                style="font-weight: 700; color: #32325d; text-transform: uppercase; letter-spacing: 0.5px; font-size: 13px;">üìã
                Section</label>
            <select id="newSection" style="
                    padding: 12px 16px;
                    border: 2px solid #e3e3e3;
                    border-radius: 8px;
                    font-size: 14px;
                    font-family: inherit;
                    background: white;
                    color: #32325d;
                    cursor: pointer;
                " required>
                <option value="">-- Select Section --</option>
                <option value="A">Section A</option>
                <option value="B">Section B</option>
                <option value="C">Section C</option>
                <option value="D">Section D</option>
            </select>
        </div>

        <button type="button" onclick="addStudentRow()" style="
                padding: 12px 24px;
                background: linear-gradient(135deg, #2dce89 0%, #11cdef 100%);
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(45, 206, 137, 0.3);
                font-size: 12px;
            "
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(45, 206, 137, 0.4)'"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(45, 206, 137, 0.3)'">
            ‚ûï Add Row
        </button>
    </div>

    <form method="POST" action="{{ url_for('submit_student_sheet') }}" id="studentSheetForm">
        <div style="overflow-x: auto; margin-bottom: 20px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #fb6340 0%, #ff6b9d 100%); color: white;">
                        <th
                            style="padding: 15px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; font-size: 13px;">
                            üìù Register Number</th>
                        <th
                            style="padding: 15px; text-align: left; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; font-size: 13px;">
                            üë§ Student Name</th>
                        <th
                            style="padding: 15px; text-align: center; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; font-size: 13px; width: 60px;">
                            Action</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <!-- Rows will be added here -->
                </tbody>
            </table>
        </div>

        <input type="hidden" id="classField" name="sheet_class" value="">
        <input type="hidden" id="sectionField" name="sheet_section" value="">
        <input type="hidden" id="studentDataField" name="student_data" value="">

        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button type="button" onclick="toggleStudentSheet()" style="
                    padding: 12px 28px;
                    background: #f0f0f0;
                    color: #333;
                    border: none;
                    border-radius: 8px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                Cancel
            </button>
            <button type="submit" style="
                    padding: 12px 28px;
                    background: linear-gradient(135deg, #fb6340 0%, #ff6b9d 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(251, 99, 64, 0.3);
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(251, 99, 64, 0.4)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(251, 99, 64, 0.3)'">
                ‚úÖ Save Students
            </button>
        </div>
    </form>
</div>
</div>
<div style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
    <h1 style="margin: 0; padding: 0;">üìä Mark Attendance</h1>
    <a href="{{ url_for('dashboard') }}" style="
        padding: 12px 24px;
        background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(94, 114, 228, 0.3);
        font-size: 14px;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(94, 114, 228, 0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(94, 114, 228, 0.3)'">
        üè† Dashboard
    </a>
</div>
<p style="margin: 0 0 20px 0; font-size: 14px; color: #636b7d;">Select a class and section to view registered students
    and mark attendance</p>

<form method="POST"
    style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); padding: 25px; border-radius: 8px; border-left: 5px solid #5e72e4; display: grid; gap: 20px; max-width: 800px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
        <div class="form-group">
            <label for="class_num" class="form-label">üìö Class</label>
            <select id="class_num" name="class_num" class="form-input" onchange="loadSubjects()" required>
                <option value="">-- Select Class --</option>

                <option value="1" {% if selected_class=="1" %}selected{% endif %}>Class 1</option>
                <option value="2" {% if selected_class=="2" %}selected{% endif %}>Class 2</option>
                <option value="3" {% if selected_class=="3" %}selected{% endif %}>Class 3</option>
                <option value="4" {% if selected_class=="4" %}selected{% endif %}>Class 4</option>
                <option value="5" {% if selected_class=="5" %}selected{% endif %}>Class 5</option>
                <option value="6" {% if selected_class=="6" %}selected{% endif %}>Class 6</option>
                <option value="7" {% if selected_class=="7" %}selected{% endif %}>Class 7</option>
                <option value="8" {% if selected_class=="8" %}selected{% endif %}>Class 8</option>
                <option value="9" {% if selected_class=="9" %}selected{% endif %}>Class 9</option>
                <option value="10" {% if selected_class=="10" %}selected{% endif %}>Class 10</option>

            </select>
        </div>

        <div class="form-group">
            <label for="section" class="form-label">üìã Section</label>
            <select id="section" name="section" class="form-input" onchange="loadSubjects()" required>
                <option value="">-- Select Section --</option>

                <option value="A" {% if selected_section=="A" %}selected{% endif %}>Section A</option>
                <option value="B" {% if selected_section=="B" %}selected{% endif %}>Section B</option>
                <option value="C" {% if selected_section=="C" %}selected{% endif %}>Section C</option>
                <option value="D" {% if selected_section=="D" %}selected{% endif %}>Section D</option>

            </select>
        </div>

        <div class="form-group">
            <label for="subject_id" class="form-label">üìñ Subject (Optional)</label>
            <select id="subject_id" name="subject_id" class="form-input">
                <option value="">-- Select Subject (All if empty) --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="att_date" class="form-label">üìÖ Date</label>
            <input type="date" id="att_date" name="att_date" class="form-input" value="{{ att_date }}" required>
        </div>

        <div class="form-group" style="display: flex; align-items: flex-end;">
            <button type="submit" style="
                    padding: 12px 24px;
                    background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(94, 114, 228, 0.3);
                    width: 100%;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(94, 114, 228, 0.4)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(94, 114, 228, 0.3)'">
                üîç View Students
            </button>
        </div>
    </div>
</form>
</div>

{% if class_id %}
<form method="POST" action="{{ url_for('submit_attendance') }}"
    style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
    <input type="hidden" name="class_id" value="{{ class_id }}">
    <input type="hidden" name="subject_id" value="{{ selected_subject or '' }}">
    <input type="hidden" name="att_date" value="{{ att_date }}">

    <h2 style="margin-bottom: 20px; color: #5e72e4; border-bottom: 3px solid #5e72e4; padding-bottom: 10px;">Mark
        Attendance</h2>

    <div style="max-height: 500px; overflow-y: auto; margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%); color: white;">
                    <th style="padding: 15px; text-align: center; width: 50px;">‚úì</th>
                    <th style="padding: 15px; text-align: left;">üìù Roll No.</th>
                    <th style="padding: 15px; text-align: left;">üë§ Name</th>
                    <th style="padding: 15px; text-align: center;">Status</th>
                    {% if session.role == 'admin' %}
                    <th style="padding: 15px; text-align: center;">Action</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr style="border-bottom: 1px solid #e8ecf1; transition: all 0.3s ease;"
                    onmouseover="this.style.background='linear-gradient(90deg, rgba(94, 114, 228, 0.05), rgba(130, 94, 228, 0.05))';"
                    onmouseout="this.style.background='transparent';">
                    <td style="padding: 15px; text-align: center;">
                        <input type="checkbox" name="present[]" value="{{ student.reg_no }}"
                            style="width: 18px; height: 18px; cursor: pointer; accent-color: #5e72e4;">
                    </td>
                    <td style="padding: 15px; text-align: left; font-weight: 600; color: #333;">{{ student.reg_no }}
                    </td>
                    <td style="padding: 15px; text-align: left;">{{ student.name }}</td>
                    <td style="padding: 15px; text-align: center;">
                        <span
                            style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;"
                            class="status-badge">Absent</span>
                    </td>
                    {% if session.role == 'admin' %}
                    <td style="padding: 15px; text-align: center;">
                        <form action="{{ url_for('delete_student', student_id=student.id) }}" method="POST"
                            onsubmit="return confirm('Search for everything related to this student will be deleted. Are you sure?')">
                            <button type="submit"
                                style="background: none; border: none; color: #f5365c; cursor: pointer; font-size: 18px;"
                                title="Delete Student">üóëÔ∏è</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div
        style="display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 2px solid #e8ecf1; gap: 10px; flex-wrap: wrap;">
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('dashboard') }}"
                style="padding: 12px 24px; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;"
                onmouseover="this.style.background='#e0e0e0';" onmouseout="this.style.background='#f0f0f0';">Back</a>

            <a href="{{ url_for('history') }}"
                style="padding: 12px 24px; background: linear-gradient(135deg, #11cdef 0%, #0da5c0 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(17, 205, 239, 0.3);"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 25px rgba(17, 205, 239, 0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(17, 205, 239, 0.3)';">üìú
                History</a>
        </div>

        <button type="submit" class="btn-primary" style="padding: 12px 32px;">‚úÖ Submit Attendance</button>
    </div>
</form>
{% else %}

<div
    style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); border-radius: 8px;">
    <div style="font-size: 60px; margin-bottom: 20px;">üìã</div>
    <h2 style="color: #5e72e4; margin-bottom: 10px;">No Students Selected</h2>
    <p style="color: #666; margin-bottom: 20px;">Please select a class and section above to view students</p>
</div>
{% endif %}

<script>
    let rowCount = 0;

    function toggleStudentSheet() {
        const panel = document.getElementById('studentSheetPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth' });
            if (rowCount === 0) addStudentRow();
        } else {
            panel.style.display = 'none';
        }
    }

    function addStudentRow() {
        rowCount++;
        const tbody = document.getElementById('studentTableBody');
        const row = document.createElement('tr');
        row.id = `row-${rowCount}`;
        row.innerHTML = `
            <td style="padding: 12px;"><input type="text" class="reg-input" placeholder="e.g., 001" style="width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;"><input type="text" class="name-input" placeholder="e.g., Alice Smith" style="width: 95%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px; text-align: center;"><button type="button" onclick="removeStudentRow(${rowCount})" style="background: #fee; color: #f5365c; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button></td>
        `;
        tbody.appendChild(row);
    }

    function removeStudentRow(rowNum) {
        const row = document.getElementById(`row-${rowNum}`);
        if (row) row.remove();
    }

    document.getElementById('studentSheetForm').addEventListener('submit', function (e) {
        const rows = document.querySelectorAll('#studentTableBody tr');
        const studentData = [];
        const sheetClass = document.getElementById('newClass').value;
        const sheetSection = document.getElementById('newSection').value;

        if (!sheetClass || !sheetSection) {
            e.preventDefault();
            alert('Please select Class and Section');
            return;
        }

        rows.forEach(row => {
            const regNo = row.querySelector('.reg-input').value.trim();
            const name = row.querySelector('.name-input').value.trim();
            if (regNo && name) {
                studentData.push({ regNo, studentName: name });
            }
        });

        if (studentData.length === 0) {
            e.preventDefault();
            alert('Please add at least one student');
            return;
        }

        document.getElementById('classField').value = sheetClass;
        document.getElementById('sectionField').value = sheetSection;
        document.getElementById('studentDataField').value = JSON.stringify(studentData);
    });

    // Load subjects when class and section are selected
    function loadSubjects() {
        const classNum = document.getElementById('class_num').value;
        const section = document.getElementById('section').value;
        const subjectSelect = document.getElementById('subject_id');

        if (!classNum || !section) {
            subjectSelect.innerHTML = '<option value="">-- Select Subject (All if empty) --</option>';
            return;
        }

        // Fetch subjects for this class/section
        fetch(`/get_subjects/${classNum}-${section}`)
            .then(response => response.json())
            .then(data => {
                let html = '<option value="">-- Select Subject (All if empty) --</option>';
                data.forEach(subject => {
                    html += `<option value="${subject.id}">${subject.subject_name}</option>`;
                });
                subjectSelect.innerHTML = html;
            })
            .catch(error => {
                console.log('Could not load subjects:', error);
                subjectSelect.innerHTML = '<option value="">-- Select Subject (All if empty) --</option>';
            });
    }

    document.querySelectorAll('input[name="present[]"]').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const row = this.closest('tr');
            const badge = row.querySelector('.status-badge');
            if (this.checked) {
                row.style.background = '#e8f5e9';
                badge.style.background = '#2dce89';
                badge.style.color = 'white';
                badge.textContent = 'Present';
            } else {
                row.style.background = 'transparent';
                badge.style.background = '#f5f5f5';
                badge.style.color = '#999';
                badge.textContent = 'Absent';
            }
        });
    });

    function toggleManageSubjects() {
        const panel = document.getElementById('manageSubjectsPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function toggleManageClasses() {
        const panel = document.getElementById('manageClassesPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function loadSubjectsForManagement() {
        const classNum = document.getElementById('manageClassNum').value;
        const section = document.getElementById('manageSection').value;
        if (!classNum || !section) return alert('Select Class and Section');

        try {
            const resp = await fetch(`/get_subjects/${classNum}-${section}`);
            const subjects = await resp.json();
            const list = document.getElementById('subjectsList');
            list.innerHTML = '';

            subjects.forEach(s => {
                const div = document.createElement('div');
                div.style.background = '#f0f4ff';
                div.style.border = '1px solid #5e72e4';
                div.style.color = '#5e72e4';
                div.style.padding = '5px 12px';
                div.style.borderRadius = '20px';
                div.style.fontSize = '13px';
                div.style.fontWeight = '600';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '8px';
                div.innerHTML = `
                    ${s.subject_name}
                    <form action="/delete_subject/${s.id}" method="POST" style="margin: 0; display: inline;" onsubmit="return confirm('Deleting this subject will also delete all related marks and attendance. Are you sure?')">
                        <button type="submit" style="background: none; border: none; color: #f5365c; cursor: pointer; padding: 0; font-weight: bold; font-size: 14px;">‚úï</button>
                    </form>
                `;
                list.appendChild(div);
            });
            if (subjects.length === 0) list.innerHTML = '<p style="color: #999; font-size: 13px;">No subjects found.</p>';
        } catch (e) {
            console.error(e);
            alert('Failed to load subjects');
        }
    }
</script>
